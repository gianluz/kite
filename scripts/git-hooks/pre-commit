#!/bin/sh
#
# Git pre-commit hook to check version synchronization
#
# Ensures that when build.gradle.kts version is changed,
# the README.md version badge is also updated.
#
# To install:
#   ./gradlew build  (hooks install automatically)
#
# To bypass (use sparingly):
#   git commit --no-verify
#

# Check if ROOT build.gradle.kts is being committed (not subproject)
CHANGED_FILES=$(git diff --cached --name-only)

# Only check if the root build.gradle.kts is modified (version is there)
if echo "$CHANGED_FILES" | grep -q "^build.gradle.kts$"; then
    echo "üîç Detected build.gradle.kts change, checking version synchronization..."
    
    # Check if kite-cli is built
    if [ ! -f "kite-cli/build/install/kite-cli/bin/kite-cli" ]; then
        echo "üì¶ Building Kite CLI..."
        ./gradlew :kite-cli:installDist --quiet --no-daemon > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "‚ùå Failed to build Kite CLI"
            exit 1
        fi
    fi
    
    # Run version sync check (capture both stdout and stderr)
    CHECK_OUTPUT=$(kite-cli/build/install/kite-cli/bin/kite-cli run check-version-sync 2>&1)
    CHECK_EXIT=$?
    
    # Filter out JVM warnings
    FILTERED_OUTPUT=$(echo "$CHECK_OUTPUT" | grep -v "^Picked up\|^OpenJDK\|^WARNING:")
    
    if [ $CHECK_EXIT -eq 0 ]; then
        echo ""
        echo "‚úÖ Version synchronization OK!"
    else
        # Only show output if there's an actual error (not just warnings)
        if echo "$FILTERED_OUTPUT" | grep -q "Version mismatch"; then
            echo ""
            echo "$FILTERED_OUTPUT"
            echo ""
            echo "üí° Quick fix:"
            echo "   kite-cli/build/install/kite-cli/bin/kite-cli run update-version-badge"
            echo "   git add README.md"
            echo ""
            echo "‚ö†Ô∏è  To bypass this check (not recommended):"
            echo "   git commit --no-verify"
            echo ""
            exit 1
        else
            # Other error, show it
            echo ""
            echo "$FILTERED_OUTPUT"
            echo ""
            echo "‚ö†Ô∏è  Version check failed. To bypass:"
            echo "   git commit --no-verify"
            echo ""
            exit 1
        fi
    fi
fi

# All good!
exit 0
